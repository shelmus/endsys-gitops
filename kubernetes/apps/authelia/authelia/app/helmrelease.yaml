# https://artifacthub.io/packages/helm/open-webui/open-webui?modal=values
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authelia
spec:
  interval: 1h
  chart:
    spec:
      chart: authelia
      version: 0.10.46
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    pod:
      kind: Deployment
    # Mount the users database secret at /config/users_database.yml
      extraVolumeMounts:
        - name: users-db
          mountPath: /config/users_database.yml
          subPath: users_database.yml
          readOnly: true
      extraVolumes:
        - name: users-db
          secret:
            secretName: authelia-users
    secret:
      existingSecret: authelia-secrets
    configMap: 
      totp:
        disable: false
        issuer: 'Homelab'
      session:
        # Must be the cookie domain youâ€™ll serve Authelia and protected apps from
        cookies:
          - domain: auth.endsys.cloud
      storage:
        # Simple local storage for quick start (no HA). For HA use postgres.
        local:
          enabled: true
      notifier:
        smtp:
          enabled: true
          address: 'submission://smtp.protonmail.ch:587'
          sender: 'Authelia <infra@endsys.cloud>'
          username: 'infra@endsys.cloud'
          password:
            secret_name: authelia-secrets
            # value: password
        filesystem:
          enabled: false
      authentication_backend:
        file:
          enabled: true
          path: /config/users_database.yml
      access_control:
        default_policy: deny
        rules:
          - domain: "auth.endsys.cloud"
            policy: bypass
          - domain: "*.endsys.cloud"
            subject: ["group:admins"]
            policy: one_factor
    # Use your own crypto keys instead of auto-generated ones
      identity_providers:
        oidc:
          jwks:
            - key_id: 'auth-rs256-2025-08'
              algorithm: 'RS256'
              use: 'sig'
              key:
                value: ""
              certificate_chain:
                value: ""
          enabled: true
          clients:
            - client_id: openwebui
              client_secret: ""
              client_name: "Openwebui"
              public: false
              authorization_policy: 'two_factor'
              require_pkce: false
              pkce_challenge_method: ''
              redirect_uris:
                - 'https://ai.endsys.cloud/oauth/oidc/callback'
              scopes:
                - 'openid'
                - 'profile'
                - 'groups'
                - 'email'
              response_types:
                - 'code'
              grant_types:
                - 'authorization_code'
              access_token_signed_response_alg: 'none'
              userinfo_signed_response_alg: 'none'
              token_endpoint_auth_method: 'client_secret_basic'
  valuesFrom:
    - kind: Secret
      name: authelia-oidc-jwks
      valuesKey: jwk_private_key
      targetPath: configMap.identity_providers.oidc.jwks[0].key.value
    - kind: Secret     # you can use ConfigMap if you consider it non-sensitive
      name: authelia-oidc-jwks
      valuesKey: jwk_certificate_chain
      targetPath: configMap.identity_providers.oidc.jwks[0].certificate_chain.value
    - kind: Secret
      name: openwebui-sso-client-secret           # <- the Secret Flux decrypts
      valuesKey: client_secret             # <- key inside the Secret
      targetPath: configMap.identity_providers.oidc.clients[0].client_secret
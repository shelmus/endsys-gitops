---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/externalsecret_v1beta1.json
# ExternalSecret for authentik using Bitwarden Secrets Manager
#
# Required Bitwarden secrets (create these in Bitwarden Secrets Manager):
#   - authentik-secret-key: Secret key for authentik (used for signing, generate with `openssl rand -base64 36`)
#   - authentik-postgresql-password: PostgreSQL password for authentik database user
#   - authentik-redis-password: Redis password for authentik
#
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: authentik-secrets
  labels:
    app.kubernetes.io/name: authentik
    app.kubernetes.io/instance: authentik
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: authentik
spec:
  # How often to sync secrets from Bitwarden
  refreshInterval: 1h

  # Reference the ClusterSecretStore
  secretStoreRef:
    kind: ClusterSecretStore
    name: bitwarden-secretsmanager

  # Target Kubernetes secret to create/update
  target:
    name: authentik-secrets
    creationPolicy: Owner
    deletionPolicy: Retain

  # Map Bitwarden secrets to Kubernetes secret keys
  data:
    # Authentik secret key for signing tokens and encrypting data
    - secretKey: secret-key
      remoteRef:
        key: authentik-secret-key

    # PostgreSQL database password
    - secretKey: postgresql-password
      remoteRef:
        key: authentik-postgresql-password

    # Redis password
    - secretKey: redis-password
      remoteRef:
        key: authentik-redis-password

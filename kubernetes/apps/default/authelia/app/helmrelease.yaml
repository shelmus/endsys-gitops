# https://artifacthub.io/packages/helm/open-webui/open-webui?modal=values
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authelia
spec:
  interval: 1h
  chart:
    spec:
      chart: authelia
      version: 0.10.42
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    pod:
      kind: Deployment
    # Mount the users database secret at /config/users_database.yml
      extraVolumeMounts:
        - name: users-db
          mountPath: /config/users_database.yml
          subPath: users_database.yml
          readOnly: true
      extraVolumes:
        - name: users-db
          secret:
            secretName: authelia-users
    secret:
      existingSecret: authelia-secrets
    configMap:
      session:
        # Must be the cookie domain you’ll serve Authelia and protected apps from
        cookies:
          - domain: auth.endsys.cloud
      storage:
        # Simple local storage for quick start (no HA). For HA use postgres.
        local:
          enabled: true
      notifier:
        # Writes “emails” to a file in the pod; swap to SMTP in production
        filesystem:
          enabled: true
      authentication_backend:
        file:
          enabled: true
          path: /config/users_database.yml
      access_control:
        default_policy: deny
        rules:
          - domain: "auth.endsys.cloud"
            policy: bypass
          - domain: "*.endsys.cloud"
            subject: ["group:admins"]
            policy: one_factor
    # Use your own crypto keys instead of auto-generated ones
      identity_providers:
        oidc:
          jwks:
            - key_id: 'auth-rs256-2025-08'
              algorithm: 'RS256'
              use: 'sig'
              key: ""
              certificate_chain: |
                -----BEGIN CERTIFICATE-----
                MIIDHjCCAgagAwIBAgIRAIGHyGZvnC2+8Lf1b0Ff5BgwDQYJKoZIhvcNAQELBQAw
                LzERMA8GA1UEChMIQXV0aGVsaWExGjAYBgNVBAMTEWF1dGguZW5kc3lzLmNsb3Vk
                MB4XDTI1MDgyNTIwNDcxOVoXDTI2MDgyNTIwNDcxOVowLzERMA8GA1UEChMIQXV0
                aGVsaWExGjAYBgNVBAMTEWF1dGguZW5kc3lzLmNsb3VkMIIBIjANBgkqhkiG9w0B
                AQEFAAOCAQ8AMIIBCgKCAQEAuCX9R2iwSjcMo7MbGqu8pnIxOipKWuYWnaSyZjnl
                ZF2IQ1FejZFtSJhCecVBatlYsXAs/JcKVLPe+pY5lhdAewkV82tDM5n29zkXmDcm
                YmiC7HgajaiNpmtwHedsdFtZtFetWWcElivUpC3kWf03I8o972t7LhZnpqR9gDQ0
                kYTZMv7mWhBkvpRxMutefN0UR4sZJKhxArliDZtNULHADGwA/XX+xDaJdq9BCt/1
                jHfrbjg0FpWqztWOofygYE9frqtUVkCf+vRrfaB4x2BFzEUbGUchMqlUTBPyZsOy
                ufijBuc/3Rc39eG50Hid76zCF3VUi2F1Q6gTDlOsDJsYYQIDAQABozUwMzAOBgNV
                HQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEwDAYDVR0TAQH/BAIwADAN
                BgkqhkiG9w0BAQsFAAOCAQEAKTo2wtHTJCsix/TNNTSgq2LzTpTcuP4jyy2SQiVl
                H98fMj2XncVd4Bj095x8KKlaST3mLjxfyW3d5PvOIP29TFSloYl/7iRsvD+6oj1B
                rxSQeKth4SFSpFALHPGl2Z0ZnMm9BgyeTdIU4g9xYji9GMsEziO/QqaDNv+87FO4
                dNWH6ivbTMbliDETC+uiN8xOj5zGdqIcvJYCi0beoukY8Gqs99KVG1tiUOupqL/s
                q2MFUpqfiVm+4+9ZlY1VmLVwf+6BoBuZQHgkW6L9dan4ebafE7ZxUs9UEPJ9Tw65
                NB0JIATZDvxKIkDcq0sn4MDciAjNAHmWVCX4Y8RmKze7xg==
                -----END CERTIFICATE-----
          enabled: true
          clients:
            - client_id: openwebui
              client_secret: ""
              client_name: "Openwebui"
              public: false
              authorization_policy: 'two_factor'
              require_pkce: false
              pkce_challenge_method: ''
              redirect_uris:
                - 'https://ai.endsys.cloud/oauth/oidc/callback'
              scopes:
                - 'openid'
                - 'profile'
                - 'groups'
                - 'email'
              response_types:
                - 'code'
              grant_types:
                - 'authorization_code'
              access_token_signed_response_alg: 'none'
              userinfo_signed_response_alg: 'none'
              token_endpoint_auth_method: 'client_secret_basic'
  valuesFrom:
    - kind: Secret
      name: authelia-oidc-jwks
      valuesKey: jwk_private_key
      targetPath: configMap.identity_providers.oidc.jwks[0].key
    # - kind: Secret     # you can use ConfigMap if you consider it non-sensitive
    #   name: authelia-oidc-jwks
    #   valuesKey: jwk_certificate_chain
    #   targetPath: configMap.identity_providers.oidc.jwks[0].certificate_chain
    - kind: Secret
      name: authelia-oidc-client           # <- the Secret Flux decrypts
      valuesKey: client_secret             # <- key inside the Secret
      targetPath: configMap.identity_providers.oidc.clients[0].client_secret
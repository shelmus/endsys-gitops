---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/clustersecretstore_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: bitwarden-secretsmanager
  labels:
    app.kubernetes.io/name: bitwarden-secretsmanager
    app.kubernetes.io/instance: bitwarden-secretsmanager
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: external-secrets
spec:
  provider:
    bitwardensecretsmanager:
      # Bitwarden API URL
      # For self-hosted Bitwarden: https://your-bitwarden-instance.com/api
      # For Bitwarden cloud (default): https://api.bitwarden.com
      apiURL: https://api.bitwarden.com

      # Bitwarden Identity URL
      # For self-hosted Bitwarden: https://your-bitwarden-instance.com/identity
      # For Bitwarden cloud (default): https://identity.bitwarden.com
      identityURL: https://identity.bitwarden.com

      # Internal Bitwarden SDK Server URL
      # This points to the bitwarden-sdk-server deployed as part of ESO
      # The SDK server runs on port 9998 with HTTPS
      bitwardenServerSDKURL: https://bitwarden-sdk-server.external-secrets.svc.cluster.local:9998

      # CA Bundle for the SDK Server TLS certificate
      # This references the CA certificate created by cert-manager
      # The caProvider allows ESO to trust the self-signed certificate
      caProvider:
        type: Secret
        name: bitwarden-sdk-ca-secret
        namespace: external-secrets
        key: ca.crt

      # Organization ID from Bitwarden Secrets Manager
      # Find this in: Bitwarden > Secrets Manager > Machine Accounts > Your Organization
      # Format: UUID (e.g., "7c0d21ec-10d9-4972-bdf8-ec52df99cc86")
      # IMPORTANT: Replace with your actual organization ID
      organizationID: "${SECRET_BITWARDEN_ORGANIZATION_ID}"

      # Project ID from Bitwarden Secrets Manager
      # Find this in: Bitwarden > Secrets Manager > Projects > Your Project > Settings
      # Format: UUID (e.g., "9c713cd6-728c-437a-a783-252b0773a0bb")
      # IMPORTANT: Replace with your actual project ID
      projectID: "${SECRET_BITWARDEN_PROJECT_ID}"

      # Authentication using Machine Account Access Token
      # The access token is stored in a Kubernetes secret
      auth:
        secretRef:
          credentials:
            # Name of the secret containing the Bitwarden access token
            name: bitwarden-access-token
            # Key within the secret that holds the token
            key: token
            # Namespace where the secret is located
            namespace: external-secrets

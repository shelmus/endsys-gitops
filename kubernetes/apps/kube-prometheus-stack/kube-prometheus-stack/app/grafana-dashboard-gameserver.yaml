---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-gameserver
  labels:
    grafana_dashboard: "1"
data:
  gameserver.json: |
    {
      "annotations": { "list": [] },
      "editable": false,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "links": [],
      "panels": [
        {
          "title": "Host Overview",
          "type": "row",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
          "collapsed": false
        },
        {
          "title": "CPU Usage",
          "type": "gauge",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 6, "w": 4, "x": 0, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 0,
              "max": 100,
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 70 },
                  { "color": "red", "value": 90 }
                ]
              }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "100 - (avg(rate(node_cpu_seconds_total{mode=\"idle\", instance=~\"10.127.0.7:.*\"}[5m])) * 100)",
              "legendFormat": "CPU"
            }
          ]
        },
        {
          "title": "Memory Usage",
          "type": "gauge",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 6, "w": 4, "x": 4, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 0,
              "max": 100,
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 70 },
                  { "color": "red", "value": 90 }
                ]
              }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "(1 - (node_memory_MemAvailable_bytes{instance=~\"10.127.0.7:.*\"} / node_memory_MemTotal_bytes{instance=~\"10.127.0.7:.*\"})) * 100",
              "legendFormat": "Memory"
            }
          ]
        },
        {
          "title": "Disk Usage (/)",
          "type": "gauge",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 6, "w": 4, "x": 8, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 0,
              "max": 100,
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 70 },
                  { "color": "red", "value": 85 }
                ]
              }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "(1 - (node_filesystem_avail_bytes{instance=~\"10.127.0.7:.*\", mountpoint=\"/\", fstype!=\"tmpfs\"} / node_filesystem_size_bytes{instance=~\"10.127.0.7:.*\", mountpoint=\"/\", fstype!=\"tmpfs\"})) * 100",
              "legendFormat": "Disk"
            }
          ]
        },
        {
          "title": "Uptime",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 6, "w": 4, "x": 12, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null }
                ]
              }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "time() - node_boot_time_seconds{instance=~\"10.127.0.7:.*\"}",
              "legendFormat": "Uptime"
            }
          ]
        },
        {
          "title": "Total Memory",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 6, "w": 4, "x": 16, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "unit": "bytes",
              "thresholds": {
                "steps": [
                  { "color": "blue", "value": null }
                ]
              }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "node_memory_MemTotal_bytes{instance=~\"10.127.0.7:.*\"}",
              "legendFormat": "Total"
            }
          ]
        },
        {
          "title": "Load Average",
          "type": "stat",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 6, "w": 4, "x": 20, "y": 1 },
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 4 },
                  { "color": "red", "value": 8 }
                ]
              }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "node_load5{instance=~\"10.127.0.7:.*\"}",
              "legendFormat": "5m avg"
            }
          ]
        },
        {
          "title": "CPU Usage Over Time",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 7 },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 0,
              "max": 100,
              "custom": { "fillOpacity": 20, "lineWidth": 2 }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "100 - (avg(rate(node_cpu_seconds_total{mode=\"idle\", instance=~\"10.127.0.7:.*\"}[5m])) * 100)",
              "legendFormat": "Total CPU"
            },
            {
              "expr": "avg(rate(node_cpu_seconds_total{mode=\"user\", instance=~\"10.127.0.7:.*\"}[5m])) * 100",
              "legendFormat": "User"
            },
            {
              "expr": "avg(rate(node_cpu_seconds_total{mode=\"system\", instance=~\"10.127.0.7:.*\"}[5m])) * 100",
              "legendFormat": "System"
            },
            {
              "expr": "avg(rate(node_cpu_seconds_total{mode=\"iowait\", instance=~\"10.127.0.7:.*\"}[5m])) * 100",
              "legendFormat": "IOWait"
            }
          ]
        },
        {
          "title": "Memory Usage Over Time",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 7 },
          "fieldConfig": {
            "defaults": {
              "unit": "bytes",
              "custom": { "fillOpacity": 20, "lineWidth": 2 }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "node_memory_MemTotal_bytes{instance=~\"10.127.0.7:.*\"}",
              "legendFormat": "Total"
            },
            {
              "expr": "node_memory_MemTotal_bytes{instance=~\"10.127.0.7:.*\"} - node_memory_MemAvailable_bytes{instance=~\"10.127.0.7:.*\"}",
              "legendFormat": "Used"
            },
            {
              "expr": "node_memory_Cached_bytes{instance=~\"10.127.0.7:.*\"}",
              "legendFormat": "Cached"
            },
            {
              "expr": "node_memory_Buffers_bytes{instance=~\"10.127.0.7:.*\"}",
              "legendFormat": "Buffers"
            }
          ]
        },
        {
          "title": "Network Traffic",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 15 },
          "fieldConfig": {
            "defaults": {
              "unit": "Bps",
              "custom": { "fillOpacity": 20, "lineWidth": 2 }
            },
            "overrides": [
              {
                "matcher": { "id": "byRegexp", "options": ".*Transmit.*" },
                "properties": [{ "id": "custom.transform", "value": "negative-Y" }]
              }
            ]
          },
          "targets": [
            {
              "expr": "rate(node_network_receive_bytes_total{instance=~\"10.127.0.7:.*\", device!~\"lo|veth.*|br-.*|docker0\"}[5m])",
              "legendFormat": "Receive {{ device }}"
            },
            {
              "expr": "rate(node_network_transmit_bytes_total{instance=~\"10.127.0.7:.*\", device!~\"lo|veth.*|br-.*|docker0\"}[5m])",
              "legendFormat": "Transmit {{ device }}"
            }
          ]
        },
        {
          "title": "Disk I/O",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 15 },
          "fieldConfig": {
            "defaults": {
              "unit": "Bps",
              "custom": { "fillOpacity": 20, "lineWidth": 2 }
            },
            "overrides": [
              {
                "matcher": { "id": "byRegexp", "options": ".*Write.*" },
                "properties": [{ "id": "custom.transform", "value": "negative-Y" }]
              }
            ]
          },
          "targets": [
            {
              "expr": "rate(node_disk_read_bytes_total{instance=~\"10.127.0.7:.*\", device!~\"dm-.*\"}[5m])",
              "legendFormat": "Read {{ device }}"
            },
            {
              "expr": "rate(node_disk_written_bytes_total{instance=~\"10.127.0.7:.*\", device!~\"dm-.*\"}[5m])",
              "legendFormat": "Write {{ device }}"
            }
          ]
        },
        {
          "title": "Filesystem Usage",
          "type": "table",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 6, "w": 24, "x": 0, "y": 23 },
          "fieldConfig": {
            "defaults": { "unit": "bytes" },
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "Used %" },
                "properties": [
                  { "id": "unit", "value": "percent" },
                  {
                    "id": "thresholds",
                    "value": {
                      "steps": [
                        { "color": "green", "value": null },
                        { "color": "yellow", "value": 70 },
                        { "color": "red", "value": 85 }
                      ]
                    }
                  },
                  { "id": "custom.displayMode", "value": "color-background" }
                ]
              }
            ]
          },
          "transformations": [
            { "id": "merge", "options": {} },
            {
              "id": "organize",
              "options": {
                "excludeByName": { "Time": true, "instance": true, "job": true, "__name__": true, "device": true, "fstype": true },
                "renameByName": { "mountpoint": "Mount", "Value #A": "Size", "Value #B": "Available", "Value #C": "Used %" }
              }
            }
          ],
          "targets": [
            {
              "expr": "node_filesystem_size_bytes{instance=~\"10.127.0.7:.*\", fstype!~\"tmpfs|overlay\"}",
              "legendFormat": "",
              "format": "table",
              "instant": true,
              "refId": "A"
            },
            {
              "expr": "node_filesystem_avail_bytes{instance=~\"10.127.0.7:.*\", fstype!~\"tmpfs|overlay\"}",
              "legendFormat": "",
              "format": "table",
              "instant": true,
              "refId": "B"
            },
            {
              "expr": "(1 - (node_filesystem_avail_bytes{instance=~\"10.127.0.7:.*\", fstype!~\"tmpfs|overlay\"} / node_filesystem_size_bytes{instance=~\"10.127.0.7:.*\", fstype!~\"tmpfs|overlay\"})) * 100",
              "legendFormat": "",
              "format": "table",
              "instant": true,
              "refId": "C"
            }
          ]
        },
        {
          "title": "Docker Containers",
          "type": "row",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 29 },
          "collapsed": false
        },
        {
          "title": "Container CPU Usage",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 30 },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "custom": { "fillOpacity": 20, "lineWidth": 2 }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "sum by (name) (rate(container_cpu_usage_seconds_total{instance=~\"10.127.0.7:.*\", name!=\"\", name!~\"cadvisor|POD\"}[5m])) * 100",
              "legendFormat": "{{ name }}"
            }
          ]
        },
        {
          "title": "Container Memory Usage",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 30 },
          "fieldConfig": {
            "defaults": {
              "unit": "bytes",
              "custom": { "fillOpacity": 20, "lineWidth": 2 }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "container_memory_usage_bytes{instance=~\"10.127.0.7:.*\", name!=\"\", name!~\"cadvisor|POD\"}",
              "legendFormat": "{{ name }}"
            }
          ]
        },
        {
          "title": "Container Network Receive",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 38 },
          "fieldConfig": {
            "defaults": {
              "unit": "Bps",
              "custom": { "fillOpacity": 20, "lineWidth": 2 }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "sum by (name) (rate(container_network_receive_bytes_total{instance=~\"10.127.0.7:.*\", name!=\"\", name!~\"cadvisor|POD\"}[5m]))",
              "legendFormat": "{{ name }}"
            }
          ]
        },
        {
          "title": "Container Network Transmit",
          "type": "timeseries",
          "datasource": { "type": "prometheus", "uid": "$datasource" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 38 },
          "fieldConfig": {
            "defaults": {
              "unit": "Bps",
              "custom": { "fillOpacity": 20, "lineWidth": 2 }
            },
            "overrides": []
          },
          "targets": [
            {
              "expr": "sum by (name) (rate(container_network_transmit_bytes_total{instance=~\"10.127.0.7:.*\", name!=\"\", name!~\"cadvisor|POD\"}[5m]))",
              "legendFormat": "{{ name }}"
            }
          ]
        }
      ],
      "refresh": "30s",
      "schemaVersion": 39,
      "templating": {
        "list": [
          {
            "name": "datasource",
            "type": "datasource",
            "query": "prometheus",
            "current": { "selected": true, "text": "default", "value": "default" }
          }
        ]
      },
      "time": { "from": "now-6h", "to": "now" },
      "title": "Game Server",
      "uid": "gameserver-overview",
      "version": 1
    }

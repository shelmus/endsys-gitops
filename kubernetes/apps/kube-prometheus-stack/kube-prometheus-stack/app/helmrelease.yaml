---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
spec:
  interval: 1h
  timeout: 15m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 82.4.0
      sourceRef:
        kind: HelmRepository
        name: kube-prometheus-stack
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  valuesFrom:
    - kind: Secret
      name: alertmanager-discord
      valuesKey: webhook-url
      targetPath: alertmanager.config.receivers[0].discord_configs[0].webhook_url
  values:
    defaultRules:
      create: false
    alertmanager:
      enabled: true
      config:
        global:
          resolve_timeout: 5m
        route:
          receiver: discord
          group_by: ['alertname', 'namespace']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
          routes:
            - receiver: discord
              matchers:
                - severity=~"warning|critical"
        receivers:
          - name: discord
            discord_configs:
              - send_resolved: true
                title: '{{ if eq .Status "firing" }}ðŸ”´{{ else }}ðŸŸ¢{{ end }} {{ .GroupLabels.alertname }}'
                message: |
                  {{ range .Alerts }}
                  **{{ .Labels.alertname }}** ({{ .Labels.severity }})
                  {{ .Annotations.description }}
                  {{ end }}
      route:
        main:
          enabled: true
          hostnames: ["alertmanager.endsys.cloud"]
          parentRefs:
            - name: internal
              namespace: kube-system
              sectionName: https
    grafana:
      enabled: true
      defaultDashboardsTimezone: browsers
      envFromSecret: grafana-oauth
      grafana.ini:
        server:
          root_url: https://grafana.endsys.cloud
        auth.generic_oauth:
          enabled: true
          name: PocketID
          icon: signin
          scopes: openid email profile groups
          auth_url: https://auth.endsys.cloud/authorize
          token_url: https://auth.endsys.cloud/api/oidc/token
          allow_sign_up: true
          auto_login: false
          use_pkce: true
          role_attribute_path: "contains(groups[*], 'admin') && 'Admin' || 'Viewer'"
      route:
        main:
          enabled: true
          hostnames: ["grafana.endsys.cloud"]
          parentRefs:
            - name: internal
              namespace: kube-system
              sectionName: https
    prometheus:
      route:
        main:
          enabled: true
          hostnames: ["prometheus.endsys.cloud"]
          parentRefs:
            - name: internal
              namespace: kube-system
              sectionName: https

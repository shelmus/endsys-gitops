---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: storage-alerts
  labels:
    app.kubernetes.io/name: kube-prometheus-stack
    app.kubernetes.io/component: alerting
spec:
  groups:
    - name: pvc-usage
      rules:
        - alert: PVCUsageWarning
          expr: |
            (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) * 100 > 80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PVC {{ $labels.persistentvolumeclaim }} usage above 80%"
            description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} is at {{ $value | humanize }}% capacity."

        - alert: PVCUsageCritical
          expr: |
            (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) * 100 > 90
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "PVC {{ $labels.persistentvolumeclaim }} usage above 90%"
            description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} is at {{ $value | humanize }}% capacity."

    - name: longhorn-health
      rules:
        - alert: LonghornVolumeDegraded
          expr: |
            longhorn_volume_robustness{robustness="degraded"} == 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Longhorn volume {{ $labels.volume }} is degraded"
            description: "Longhorn volume {{ $labels.volume }} has been in a degraded state for more than 5 minutes."

        - alert: LonghornVolumeFaulted
          expr: |
            longhorn_volume_robustness{robustness="faulted"} == 1
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Longhorn volume {{ $labels.volume }} is faulted"
            description: "Longhorn volume {{ $labels.volume }} has been in a faulted state for more than 1 minute."

        - alert: LonghornNodeStoragePressure
          expr: |
            (longhorn_node_storage_usage_bytes / longhorn_node_storage_capacity_bytes) * 100 > 85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Longhorn node {{ $labels.node }} storage above 85%"
            description: "Longhorn node {{ $labels.node }} disk usage is at {{ $value | humanize }}%."

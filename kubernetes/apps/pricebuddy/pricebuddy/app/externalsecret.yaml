---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/externalsecret_v1beta1.json
# ExternalSecret for pricebuddy using Bitwarden Secrets Manager
#
# Required Bitwarden secrets (create these in Bitwarden Secrets Manager):
#   - pricebuddy-db-username: Database username for pricebuddy
#   - pricebuddy-db-password: Database password for pricebuddy
#   - pricebuddy-db-root-password: MariaDB root password
#   - pricebuddy-admin-email: Admin user email address
#   - pricebuddy-admin-password: Admin user password
#
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: pricebuddy-secrets
  labels:
    app.kubernetes.io/name: pricebuddy
    app.kubernetes.io/instance: pricebuddy
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: pricebuddy
spec:
  # How often to sync secrets from Bitwarden
  refreshInterval: 1h

  # Reference the ClusterSecretStore
  secretStoreRef:
    kind: ClusterSecretStore
    name: bitwarden-secretsmanager

  # Target Kubernetes secret to create/update
  target:
    name: pricebuddy-secrets
    creationPolicy: Owner
    deletionPolicy: Retain

  # Map Bitwarden secrets to Kubernetes secret keys
  data:
    # Database credentials
    - secretKey: db-username
      remoteRef:
        key: pricebuddy-db-username

    - secretKey: db-password
      remoteRef:
        key: pricebuddy-db-password

    - secretKey: db-root-password
      remoteRef:
        key: pricebuddy-db-root-password

    # Admin user credentials (for initial seeding)
    - secretKey: admin-email
      remoteRef:
        key: pricebuddy-admin-email

    - secretKey: admin-password
      remoteRef:
        key: pricebuddy-admin-password
